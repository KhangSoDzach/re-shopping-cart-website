name: Test Secrets Format

on:
  workflow_dispatch: # Manual trigger only

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Test DOCKER_USERNAME Secret
        run: |
          echo "üîç Testing DOCKER_USERNAME secret..."
          
          # Store secret in variable
          USERNAME="${{ secrets.DOCKER_USERNAME }}"
          
          # Check length
          LENGTH=${#USERNAME}
          echo "üìè Length: $LENGTH characters"
          
          # Check for spaces
          if [[ "$USERNAME" =~ ^[[:space:]] ]] || [[ "$USERNAME" =~ [[:space:]]$ ]]; then
            echo "‚ùå ERROR: Username has leading or trailing spaces!"
            exit 1
          else
            echo "‚úÖ No leading/trailing spaces"
          fi
          
          # Check for newlines (length should match trimmed version)
          TRIMMED=$(echo "$USERNAME" | tr -d '\n\r')
          if [ "$USERNAME" != "$TRIMMED" ]; then
            echo "‚ùå ERROR: Username contains newline characters!"
            echo "Original length: ${#USERNAME}"
            echo "Trimmed length: ${#TRIMMED}"
            exit 1
          else
            echo "‚úÖ No newline characters"
          fi
          
          # Validate Docker Hub username format (alphanumeric, hyphens, underscores)
          if [[ ! "$USERNAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "‚ùå ERROR: Invalid Docker Hub username format!"
            echo "Username should only contain: letters, numbers, hyphens, underscores"
            exit 1
          else
            echo "‚úÖ Valid Docker Hub username format"
          fi
          
          # Show first and last 3 characters (for debugging)
          FIRST3="${USERNAME:0:3}"
          LAST3="${USERNAME: -3}"
          echo "üìù Username preview: ${FIRST3}...${LAST3}"
          
          # Test tag format
          TAG="${USERNAME}/shopping-cart:latest"
          echo "üè∑Ô∏è  Full tag would be: $TAG"
          
          if [[ "$TAG" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+:latest$ ]]; then
            echo "‚úÖ Tag format is valid!"
          else
            echo "‚ùå ERROR: Generated tag format is invalid!"
            exit 1
          fi
          
          echo ""
          echo "‚ú® All DOCKER_USERNAME tests passed!"

      - name: Test Other Secrets Exist
        run: |
          echo "üîç Checking if all required secrets are set..."
          
          # Test if secrets are not empty
          if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "‚ùå DOCKER_PASSWORD is not set!"
          else
            echo "‚úÖ DOCKER_PASSWORD is set (length: $(echo '${{ secrets.DOCKER_PASSWORD }}' | wc -c) chars)"
          fi
          
          if [ -z "${{ secrets.AZURE_VM_IP }}" ]; then
            echo "‚ùå AZURE_VM_IP is not set!"
          else
            echo "‚úÖ AZURE_VM_IP is set"
          fi
          
          if [ -z "${{ secrets.AZURE_VM_USER }}" ]; then
            echo "‚ùå AZURE_VM_USER is not set!"
          else
            echo "‚úÖ AZURE_VM_USER is set"
          fi
          
          if [ -z "${{ secrets.AZURE_SSH_KEY }}" ]; then
            echo "‚ùå AZURE_SSH_KEY is not set!"
          else
            SSH_KEY_LENGTH=$(echo '${{ secrets.AZURE_SSH_KEY }}' | wc -c)
            echo "‚úÖ AZURE_SSH_KEY is set (length: $SSH_KEY_LENGTH chars)"
            
            # Check if it starts with proper header
            if echo '${{ secrets.AZURE_SSH_KEY }}' | grep -q "BEGIN.*PRIVATE KEY"; then
              echo "‚úÖ SSH key has proper header"
            else
              echo "‚ö†Ô∏è  WARNING: SSH key might not have proper BEGIN PRIVATE KEY header"
            fi
          fi
          
          if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
            echo "‚ùå DB_PASSWORD is not set!"
          else
            echo "‚úÖ DB_PASSWORD is set"
          fi

      - name: Test Docker Login (Dry Run)
        run: |
          echo "üîê Testing Docker Hub credentials..."
          
          # This will actually try to login to verify credentials work
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Docker Hub login successful!"
            docker logout
          else
            echo "‚ùå Docker Hub login failed!"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "================================================"
          echo "üéØ SECRET VALIDATION SUMMARY"
          echo "================================================"
          echo ""
          echo "If all tests passed:"
          echo "  ‚úÖ Your secrets are correctly formatted"
          echo "  ‚úÖ You can safely use the main deploy workflow"
          echo ""
          echo "If any tests failed:"
          echo "  1. Go to Settings ‚Üí Secrets ‚Üí Actions"
          echo "  2. Update the failing secret"
          echo "  3. Make sure NO spaces/newlines before or after the value"
          echo "  4. Run this test workflow again"
          echo ""
          echo "================================================"
